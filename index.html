<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FiveIN - Monitoraggio Carico</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { gray: { 900: '#111827', 800: '#1f2937', 700: '#374151' } } } }
        }
    </script>

    <style>
        @font-face {
            font-family: 'DS-Digital';
            src: url('DS-DIGII.TTF') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .digital-font { font-family: 'DS-Digital', monospace; }
        .stats-row:nth-child(even) { background-color: rgba(0,0,0,0.02); }
        .dark .stats-row:nth-child(even) { background-color: rgba(255,255,255,0.02); }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen pb-20">

    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üèÄ</span>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-500">FiveIN</h1>
                </div>
                <div id="gameClockDisplay" class="digital-font text-3xl font-bold text-red-600 bg-black px-4 py-1 rounded border-2 border-gray-700 tracking-wider">
                    10:00
                </div>
                <div class="flex items-center gap-3">
                    <span id="currentQuarterLabel" class="bg-blue-100 text-blue-800 text-xs font-bold px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">Q1</span>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">üåô</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 col-span-2">
                <div class="flex flex-wrap gap-3">
                    <button id="startBtn" onclick="startClock()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg active:scale-95 text-lg">START</button>
                    <button id="stopBtn" onclick="stopClock()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg active:scale-95 text-lg">STOP</button>
                    <button onclick="nextQuarter()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 py-4 px-6 rounded-xl font-bold transition-colors">QUARTO +</button>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col justify-center text-center">
                <p class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-1">Match Time</p>
                <p id="totalMatchTime" class="text-3xl font-bold text-blue-600 digital-font">00:00</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="space-y-4">
                <h3 class="text-sm font-black uppercase tracking-widest flex items-center gap-2 text-green-600 ml-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> In Campo
                </h3>
                <div id="courtList" class="grid grid-cols-1 gap-2"></div>
            </div>
            <div class="space-y-4">
                <h3 class="text-sm font-black uppercase tracking-widest flex items-center gap-2 text-gray-500 ml-1">
                    Panchina
                </h3>
                <div id="benchList" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                <h3 class="font-bold text-lg">Box Score Carico</h3>
                <button onclick="exportCSV()" class="text-xs bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition-all">EXPORT CSV</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-100/50 dark:bg-gray-700/50 text-[10px] uppercase font-black text-gray-400">
                            <th class="px-4 py-4">#</th>
                            <th class="px-4 py-4">Nome</th>
                            <th class="px-4 py-4 text-right">Q1</th>
                            <th class="px-4 py-4 text-right">Q2</th>
                            <th class="px-4 py-4 text-right">Q3</th>
                            <th class="px-4 py-4 text-right">Q4</th>
                            <th class="px-4 py-4 text-right text-gray-900 dark:text-white">TOT</th>
                            <th class="px-4 py-4 text-right text-gray-900 dark:text-white">TGL</th>
                            <th class="px-4 py-4 text-right">Cons.</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURAZIONE FISSA (TABELLA FIX) ---
        const FIX_LOOKUP = [
            {max: 15, val: 1.05}, {max: 30, val: 1.10}, {max: 45, val: 1.15}, {max: 60, val: 1.20},
            {max: 75, val: 1.25}, {max: 90, val: 1.30}, {max: 105, val: 1.35}, {max: 120, val: 1.40},
            {max: 135, val: 1.45}, {max: 150, val: 1.50}, {max: 165, val: 1.55}, {max: 180, val: 1.60},
            {max: 195, val: 1.65}, {max: 210, val: 1.70}, {max: 225, val: 1.75}, {max: 240, val: 1.80},
            {max: 255, val: 1.83}, {max: 270, val: 1.85}, {max: 285, val: 1.88}, {max: 300, val: 1.90},
            {max: 315, val: 1.91}, {max: 330, val: 1.93}, {max: 345, val: 1.94}, {max: 360, val: 1.95},
            {max: 375, val: 1.96}, {max: 390, val: 1.98}, {max: 405, val: 1.99}, {max: 420, val: 2.00},
            {max: 435, val: 2.01}, {max: 450, val: 2.02}, {max: 465, val: 2.03}, {max: 480, val: 2.04},
            {max: 495, val: 2.05}, {max: 510, val: 2.06}, {max: 525, val: 2.07}, {max: 540, val: 2.08},
            {max: 555, val: 2.09}, {max: 570, val: 2.10}, {max: 585, val: 2.11}, {max: 600, val: 2.12}
        ];

        const TGL_ZONES = {
            VERDE: { max: 2274, color: 'text-green-500' },
            GIALLO: { max: 3695, color: 'text-yellow-500' },
            ARANCIO: { max: 4832, color: 'text-orange-500' },
            ROSSO: { max: Infinity, color: 'text-red-500' }
        };

        // --- STATO ---
        let gameState = {
            timer: null,
            remainingTime: 600000,
            currentQuarter: 'Q1',
            isClockRunning: false,
            lastTick: null
        };

        let players = [
            { id: 1, number: "00", name: "Giocatore 1", status: 'bench', performance: [] },
            { id: 2, number: "1", name: "Giocatore 2", status: 'bench', performance: [] },
            { id: 3, number: "2", name: "Giocatore 3", status: 'bench', performance: [] },
            { id: 4, number: "5", name: "Giocatore 4", status: 'bench', performance: [] },
            { id: 5, number: "8", name: "Giocatore 5", status: 'bench', performance: [] },
            { id: 6, number: "10", name: "Giocatore 6", status: 'bench', performance: [] },
            { id: 7, number: "12", name: "Giocatore 7", status: 'bench', performance: [] },
            { id: 8, number: "15", name: "Giocatore 8", status: 'bench', performance: [] },
            { id: 9, number: "21", name: "Giocatore 9", status: 'bench', performance: [] },
            { id: 10, number: "23", name: "Giocatore 10", status: 'bench', performance: [] },
            { id: 11, number: "30", name: "Giocatore 11", status: 'bench', performance: [] },
            { id: 12, number: "77", name: "Giocatore 12", status: 'bench', performance: [] }
        ];

        // --- NUOVA LOGICA CALCOLO TGL (FATIGUE MULTIPLIER) ---

        function getFatigueMultiplier(stintIndex, totMinutes) {
            const stintNum = stintIndex + 1;
            if (stintNum === 1) return 1.0;
            if (stintNum === 2) {
                if (totMinutes <= 4) return 1.005;
                if (totMinutes <= 6) return 1.007;
                if (totMinutes <= 8) return 1.010;
                return 1.012;
            }
            if (stintNum === 3) {
                if (totMinutes <= 4) return 1.003;
                if (totMinutes <= 6) return 1.005;
                if (totMinutes <= 8) return 1.008;
                if (totMinutes <= 10) return 1.010;
                if (totMinutes <= 12) return 1.013;
                if (totMinutes <= 14) return 1.014;
                if (totMinutes <= 16) return 1.016;
                if (totMinutes <= 18) return 1.018;
                return 1.020;
            }
            if (stintNum === 4) {
                if (totMinutes <= 6) return 1.000;
                if (totMinutes <= 8) return 1.005;
                if (totMinutes <= 10) return 1.008;
                if (totMinutes <= 12) return 1.010;
                if (totMinutes <= 14) return 1.013;
                if (totMinutes <= 16) return 1.016;
                if (totMinutes <= 18) return 1.018;
                if (totMinutes <= 20) return 1.020;
                if (totMinutes <= 22) return 1.023;
                if (totMinutes <= 24) return 1.026;
                if (totMinutes <= 28) return 1.030;
                return 1.035;
            }
            if (stintNum === 5) {
                if (totMinutes <= 8) return 1.000;
                if (totMinutes <= 12) return 1.002;
                if (totMinutes <= 16) return 1.005;
                if (totMinutes <= 18) return 1.010;
                if (totMinutes <= 20) return 1.012;
                if (totMinutes <= 22) return 1.015;
                if (totMinutes <= 24) return 1.020;
                if (totMinutes <= 28) return 1.025;
                return 1.035;
            }
            if (stintNum >= 6) {
                if (totMinutes <= 8) return 1.000;
                if (totMinutes <= 12) return 1.002;
                if (totMinutes <= 16) return 1.005;
                if (totMinutes <= 18) return 1.010;
                if (totMinutes <= 20) return 1.012;
                if (totMinutes <= 22) return 1.015;
                if (totMinutes <= 24) return 1.020;
                if (totMinutes <= 28) return 1.025;
                if (totMinutes <= 30) return 1.030;
                return 1.035;
            }
            return 1.0;
        }

        function getFIx(seconds) {
            const entry = FIX_LOOKUP.find(f => seconds <= f.max);
            return entry ? entry.val : 2.12;
        }

        function calcTGL(player) {
            let tglAccumulated = 0;
            let totalMinutesPlayedBefore = 0;
            let stints = [];

            // Estraggo tutti gli stint in ordine cronologico
            const quarters = ['Q1', 'Q2', 'Q3', 'Q4', 'OT', '2OT'];
            quarters.forEach(q => {
                const perf = player.performance.find(p => p.quarter === q);
                if (perf) {
                    perf.rotations.forEach(r => {
                        let durationMs = 0;
                        if (r.end !== null) {
                            durationMs = r.end - r.start;
                        } else if (q === gameState.currentQuarter && player.status === 'court') {
                            durationMs = (600000 - gameState.remainingTime) - r.start;
                        }
                        if (durationMs > 0) {
                            stints.push(durationMs / 1000);
                        }
                    });
                }
            });

            // Calcolo sequenziale
            stints.forEach((sec, idx) => {
                const fix = getFIx(sec);
                const multiplier = getFatigueMultiplier(idx, totalMinutesPlayedBefore);
                const stf = (sec * fix) * multiplier;
                tglAccumulated += stf;
                totalMinutesPlayedBefore += (sec / 60);
            });

            return Math.round(tglAccumulated);
        }

        // --- LOGICA GESTIONE TEMPO E ROTAZIONI (DAL BACKUP) ---

        function togglePlayer(id) {
            const p = players.find(x => x.id === id);
            const q = gameState.currentQuarter;
            const now = 600000 - gameState.remainingTime;

            if (p.status === 'bench') {
                const onCourt = players.filter(x => x.status === 'court').length;
                if (onCourt >= 5) return alert("Massimo 5 giocatori!");
                p.status = 'court';
                let perf = p.performance.find(x => x.quarter === q);
                if (!perf) { perf = { quarter: q, rotations: [] }; p.performance.push(perf); }
                perf.rotations.push({ start: now, end: null });
            } else {
                p.status = 'bench';
                const perf = p.performance.find(x => x.quarter === q);
                if (perf) {
                    const last = perf.rotations[perf.rotations.length - 1];
                    if (last && last.end === null) last.end = now;
                }
            }
            updateUI();
        }

        function startClock() {
            if (gameState.isClockRunning) return;
            gameState.isClockRunning = true;
            gameState.lastTick = Date.now();
            gameState.timer = setInterval(() => {
                const delta = Date.now() - gameState.lastTick;
                gameState.remainingTime -= delta;
                gameState.lastTick = Date.now();
                if (gameState.remainingTime <= 0) {
                    gameState.remainingTime = 0;
                    stopClock();
                }
                updateUI();
            }, 100);
        }

        function stopClock() {
            gameState.isClockRunning = false;
            clearInterval(gameState.timer);
            updateUI();
        }

        function nextQuarter() {
            stopClock();
            const order = ['Q1', 'Q2', 'Q3', 'Q4', 'OT', '2OT'];
            const idx = order.indexOf(gameState.currentQuarter);
            if (idx < order.length - 1) {
                // Chiudo rotazioni attive
                players.forEach(p => {
                    if (p.status === 'court') {
                        const perf = p.performance.find(x => x.quarter === gameState.currentQuarter);
                        if (perf) {
                            const last = perf.rotations[perf.rotations.length - 1];
                            if (last && last.end === null) last.end = 600000;
                        }
                    }
                });
                gameState.currentQuarter = order[idx + 1];
                gameState.remainingTime = 600000;
                // Riapro rotazioni se in campo
                players.forEach(p => {
                    if (p.status === 'court') {
                        let perf = p.performance.find(x => x.quarter === gameState.currentQuarter);
                        if (!perf) { perf = { quarter: gameState.currentQuarter, rotations: [] }; p.performance.push(perf); }
                        perf.rotations.push({ start: 0, end: null });
                    }
                });
            }
            updateUI();
        }

        // --- RENDERING UI ---

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            return `${m}:${(s % 60).toString().padStart(2, '0')}`;
        }

        function calcQuarterMs(p, q) {
            const perf = p.performance.find(x => x.quarter === q);
            if (!perf) return 0;
            return perf.rotations.reduce((acc, r) => {
                const end = r.end !== null ? r.end : (gameState.currentQuarter === q ? (600000 - gameState.remainingTime) : 600000);
                return acc + (end - r.start);
            }, 0);
        }

        function updateUI() {
            document.getElementById('gameClockDisplay').innerText = formatTime(gameState.remainingTime);
            document.getElementById('currentQuarterLabel').innerText = gameState.currentQuarter;
            
            const qIdx = ['Q1', 'Q2', 'Q3', 'Q4', 'OT', '2OT'].indexOf(gameState.currentQuarter);
            document.getElementById('totalMatchTime').innerText = formatTime((qIdx * 600000) + (600000 - gameState.remainingTime));

            const courtList = document.getElementById('courtList');
            const benchList = document.getElementById('benchList');
            const tableBody = document.getElementById('statsTableBody');

            courtList.innerHTML = ''; benchList.innerHTML = ''; tableBody.innerHTML = '';

            players.forEach(p => {
                const tgl = calcTGL(p);
                let zone = TGL_ZONES.VERDE;
                if (tgl > TGL_ZONES.ARANCIO.max) zone = TGL_ZONES.ROSSO;
                else if (tgl > TGL_ZONES.GIALLO.max) zone = TGL_ZONES.ARANCIO;
                else if (tgl > TGL_ZONES.VERDE.max) zone = TGL_ZONES.GIALLO;

                const card = `
                    <div onclick="togglePlayer(${p.id})" class="bg-white dark:bg-gray-800 p-3 rounded-xl border-2 ${p.status === 'court' ? 'border-green-500' : 'border-transparent'} shadow-sm flex justify-between items-center active:scale-95 transition-all cursor-pointer">
                        <div class="flex items-center gap-3">
                            <span class="font-black text-lg w-6">${p.number}</span>
                            <span class="font-bold">${p.name}</span>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black uppercase text-gray-400">Load</p>
                            <p class="text-sm font-black ${zone.color}">${tgl}</p>
                        </div>
                    </div>`;
                
                if (p.status === 'court') courtList.innerHTML += card;
                else benchList.innerHTML += card;

                // Calcolo minuti per tabella
                const q1 = calcQuarterMs(p, 'Q1');
                const q2 = calcQuarterMs(p, 'Q2');
                const q3 = calcQuarterMs(p, 'Q3');
                const q4 = calcQuarterMs(p, 'Q4');
                const totalMs = q1 + q2 + q3 + q4 + calcQuarterMs(p, 'OT') + calcQuarterMs(p, '2OT');
                
                let currentCons = 0;
                if (p.status === 'court') {
                    const perf = p.performance.find(x => x.quarter === gameState.currentQuarter);
                    const last = perf.rotations[perf.rotations.length - 1];
                    currentCons = (600000 - gameState.remainingTime) - last.start;
                }

                tableBody.innerHTML += `
                    <tr class="stats-row text-xs">
                        <td class="px-4 py-3 font-bold">${p.number}</td>
                        <td class="px-4 py-3 font-bold">${p.name}</td>
                        <td class="px-4 py-3 text-right text-gray-400 font-mono">${formatTime(q1)}</td>
                        <td class="px-4 py-3 text-right text-gray-400 font-mono">${formatTime(q2)}</td>
                        <td class="px-4 py-3 text-right text-gray-400 font-mono">${formatTime(q3)}</td>
                        <td class="px-4 py-3 text-right text-gray-400 font-mono">${formatTime(q4)}</td>
                        <td class="px-4 py-3 text-right font-bold font-mono">${formatTime(totalMs)}</td>
                        <td class="px-4 py-3 text-right font-black ${zone.color}">${tgl}</td>
                        <td class="px-4 py-3 text-right font-mono ${currentCons > 420000 ? 'text-red-500 animate-pulse-red font-bold' : 'text-gray-400'}">
                            ${p.status === 'court' ? formatTime(currentCons) : '-'}
                        </td>
                    </tr>`;
            });
        }

        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        function exportCSV() {
            let csv = "Numero;Nome;Q1;Q2;Q3;Q4;TOT;TGL\n";
            players.forEach(p => {
                csv += `${p.number};${p.name};${formatTime(calcQuarterMs(p,'Q1'))};${formatTime(calcQuarterMs(p,'Q2'))};${formatTime(calcQuarterMs(p,'Q3'))};${formatTime(calcQuarterMs(p,'Q4'))};${formatTime(calcQuarterMs(p,'Q1')+calcQuarterMs(p,'Q2')+calcQuarterMs(p,'Q3')+calcQuarterMs(p,'Q4'))};${calcTGL(p)}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'export_match.csv'; a.click();
        }

        updateUI();
    </script>
</body>
</html>
