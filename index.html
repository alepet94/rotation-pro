<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FiveIN</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { gray: { 900: '#111827', 800: '#1f2937', 700: '#374151' } } } }
        }
    </script>

    <style>
        @font-face {
            font-family: 'DS-Digital';
            src: url('DS-DIGII.TTF') format('truetype');
            font-weight: normal; font-style: normal;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; overscroll-behavior-y: contain; transition: background-color 0.3s, color 0.3s; }
        
        .court-area {
            background-color: #eebb88;
            background-image: repeating-linear-gradient(0deg, transparent 0px, transparent 58px, rgba(160, 82, 45, 0.15) 59px, rgba(160, 82, 45, 0.15) 60px), repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 30px, transparent 30px, transparent 60px);
            border: 6px solid #ffffff; box-shadow: inset 0 0 60px rgba(0,0,0,0.15); position: relative; min-height: 400px;
        }
        .court-lines::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: #ffffff; pointer-events: none; z-index: 1; }
        .court-lines::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 120px; border: 4px solid #ffffff; border-radius: 50%; pointer-events: none; z-index: 1; }
        .dark .court-area { background-color: #cfa06b; border-color: #e2e8f0; }
        
        .bench-area {
            background-color: #f8fafc;
            background-image: linear-gradient(45deg, #e2e8f0 25%, transparent 25%, transparent 75%, #e2e8f0 75%, #e2e8f0), linear-gradient(45deg, #e2e8f0 25%, transparent 25%, transparent 75%, #e2e8f0 75%, #e2e8f0);
            background-size: 20px 20px; border: 2px dashed #94a3b8; min-height: 140px;
        }
        .dark .bench-area { background-color: #1e293b; background-image: linear-gradient(45deg, #334155 25%, transparent 25%, transparent 75%, #334155 75%, #334155), linear-gradient(45deg, #334155 25%, transparent 25%, transparent 75%, #334155 75%, #334155); border-color: #475569; }
        
        .player-card { touch-action: manipulation; cursor: pointer; background: rgba(255, 255, 255, 0.98); border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.15s ease, box-shadow 0.15s; z-index: 10; position: relative; min-height: 9rem; height: auto; user-select: none; }
        .player-card.on-court { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); color: white; box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.4); }
        .dark .player-card:not(.on-court) { background: rgba(30, 41, 59, 0.98); color: #f1f5f9; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        /* EFFETTO GIALLO FLUO PER SELEZIONE */
        .selected-card { 
            outline: 5px solid #ccff00 !important; 
            outline-offset: 2px;
            box-shadow: 0 0 25px #ccff00 !important; 
            transform: scale(1.05); 
            z-index: 50; 
        }

        .court-number { color: #fbbf24; font-size: 1.6rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .timer-display { font-family: 'DS-Digital', 'Courier New', monospace; font-weight: 700; font-size: 3rem; line-height: 1; letter-spacing: -2px; color: #ef4444; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="p-2 sm:p-6 bg-gray-100 dark:bg-gray-900 select-none h-screen flex flex-col">

    <div class="max-w-7xl mx-auto w-full flex flex-col h-full safe-area-padding">
        
        <header class="flex justify-between items-center mb-3 py-2 flex-shrink-0 flex-wrap gap-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4 flex-1">
                <div><h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800 dark:text-white tracking-tight">üèÄ FiveIN</h1></div>
                <div class="mt-2 sm:mt-0 flex items-center">
                    <label class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-2 flex-shrink-0">Avversaria:</label>
                    <input type="text" id="opponent-name" placeholder="Nome Squadra" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white font-medium text-sm py-1 px-2 rounded-lg outline-none w-full max-w-xs">
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="exportToCSV()" class="p-2 rounded-full bg-blue-600 text-white shadow-sm text-xs font-bold uppercase">CSV</button>
                <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 rounded-full bg-white dark:bg-gray-800 text-gray-800 dark:text-yellow-400">üåô/‚òÄÔ∏è</button>
            </div>
        </header>

        <div id="setup-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Roster Squadra</h2>
                <textarea id="player-input" rows="8" class="w-full p-4 border rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white">00 Leardini
7 Tomassini
11 Denegri
12 Sankare
13 Marini
17 Ogden
18 Pollone
22 Robinson
27 Simioni
29 Camara</textarea>
                <button onclick="initializeGame()" class="mt-4 w-full bg-blue-600 text-white font-bold py-4 rounded-xl">Inizia Partita</button>
            </div>
        </div>

        <div id="game-container" class="flex-1 flex flex-col min-h-0 pb-4 hidden">
            <div class="bg-white dark:bg-gray-800 p-3 sm:p-4 rounded-2xl shadow-sm mb-4 flex flex-wrap sm:flex-nowrap justify-between items-center gap-4 border border-gray-200 dark:border-gray-700">
                <div class="flex-1 flex justify-center items-center gap-3 order-1 sm:order-2">
                    <button onclick="adjustTime(30000)" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 font-bold text-xs">+30"</button>
                    <div class="bg-gray-100 dark:bg-gray-900 px-6 py-2 rounded-xl border border-gray-200 dark:border-gray-700 min-w-[200px] text-center">
                        <span id="timer-display" class="timer-display">10:00</span>
                    </div>
                    <button onclick="adjustTime(-30000)" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 font-bold text-xs">-30"</button>
                </div>
                <div class="order-2 sm:order-3">
                    <select id="quarter-select" onchange="changeQuarter()" class="bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 text-gray-800 dark:text-white font-bold text-lg py-3 px-4 rounded-xl outline-none">
                        <option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option><option value="OT">OT</option>
                    </select>
                </div>
                <div class="flex gap-2 order-3 sm:order-1">
                    <button id="start-pause-btn" onclick="toggleTimer()" class="bg-green-600 text-white font-bold py-3 px-4 rounded-xl w-24">Avvia</button>
                    <button id="undo-btn" onclick="undoSubstitution()" class="bg-orange-500 text-white font-bold py-3 px-4 rounded-xl w-24 opacity-50 cursor-not-allowed">UNDO</button>
                    <button onclick="localStorage.removeItem('basket_rotation_fivein_v1'); location.reload();" class="bg-red-500 text-white font-bold py-3 px-4 rounded-xl w-24">Reset</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 flex-1 min-h-0">
                <div class="lg:col-span-3 flex flex-col min-h-0 order-2 lg:order-1">
                    <div id="bench-area" class="bench-area p-3 rounded-xl flex-1 overflow-y-auto grid grid-cols-2 lg:grid-cols-1 gap-3 content-start"></div>
                </div>
                <div class="lg:col-span-9 flex flex-col min-h-0 order-1 lg:order-2 space-y-4">
                    <div class="relative rounded-2xl overflow-hidden shadow-2xl border-[6px] border-white dark:border-gray-500 flex-1 flex flex-col">
                        <div class="court-lines absolute inset-0 z-0"></div>
                        <div id="court-area" class="court-area relative z-10 p-4 sm:p-6 flex-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 sm:gap-4 content-start items-start"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col h-48 lg:h-64 overflow-hidden">
                        <div id="total-stats-area" class="overflow-y-auto custom-scroll p-0 flex-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FIX_LOOKUP = [
            {l:16, v:1.00},{l:34, v:1.01},{l:47, v:1.02},{l:59, v:1.03},{l:70, v:1.04},{l:81, v:1.05},{l:90, v:1.06},{l:99, v:1.07},{l:108, v:1.08},{l:116, v:1.09},{l:124, v:1.10},
            {l:132, v:1.11},{l:140, v:1.12},{l:147, v:1.13},{l:154, v:1.14},{l:161, v:1.15},{l:168, v:1.16},{l:175, v:1.17},{l:182, v:1.18},{l:188, v:1.19},{l:194, v:1.20},
            {l:300, v:1.39},{l:420, v:1.65},{l:540, v:1.95},{l:600, v:2.10},{l:9999, v:2.11}
        ];

        let gameState = { players: [], isRunning: false, lastUpdateTime: 0, currentQuarter: 'Q1', quarterTimes: {} };
        let history = []; 
        let timerInterval = null;
        let selectedPlayerId = null;

        function getFatigueMultiplier(idx, totMin) {
            const s = idx + 1;
            if (s === 1) return 1.0;
            if (s === 2) return totMin <= 4 ? 1.005 : (totMin <= 6 ? 1.007 : (totMin <= 8 ? 1.010 : 1.012));
            if (s === 3) return totMin <= 4 ? 1.003 : (totMin <= 6 ? 1.005 : (totMin <= 8 ? 1.008 : (totMin <= 10 ? 1.010 : (totMin <= 12 ? 1.013 : (totMin <= 14 ? 1.014 : (totMin <= 16 ? 1.016 : (totMin <= 18 ? 1.018 : 1.020)))))));
            if (s === 4) return totMin <= 6 ? 1.0 : (totMin <= 8 ? 1.005 : (totMin <= 10 ? 1.008 : (totMin <= 12 ? 1.010 : (totMin <= 14 ? 1.013 : (totMin <= 16 ? 1.016 : (totMin <= 18 ? 1.018 : (totMin <= 20 ? 1.020 : (totMin <= 22 ? 1.023 : (totMin <= 24 ? 1.026 : (totMin <= 28 ? 1.030 : 1.035))))))))));
            if (s >= 5) return totMin <= 8 ? 1.0 : (totMin <= 12 ? 1.002 : (totMin <= 16 ? 1.005 : (totMin <= 18 ? 1.010 : (totMin <= 20 ? 1.012 : (totMin <= 22 ? 1.015 : (totMin <= 24 ? 1.020 : (totMin <= 28 ? 1.025 : 1.035)))))));
            return 1.0;
        }

        function calcTGL(player) {
            let tgl = 0, totMinBefore = 0, stints = [];
            player.performance.forEach(perf => {
                perf.rotations.forEach(r => {
                    let d = r.end !== null ? r.end - r.start : (perf.quarter === gameState.currentQuarter && player.status === 'court' ? (600000 - gameState.quarterTimes[gameState.currentQuarter]) - r.start : 0);
                    if (d > 0) stints.push(d / 1000);
                });
            });
            stints.forEach((sec, i) => {
                const fix = (FIX_LOOKUP.find(e => sec <= e.l) || {v:2.11}).v;
                tgl += (sec * fix * getFatigueMultiplier(i, totMinBefore));
                totMinBefore += (sec / 60);
            });
            return Math.round(tgl);
        }

        function calcTotalMs(player) {
            return player.performance.reduce((acc, p) => acc + p.rotations.reduce((rAcc, r) => {
                let d = r.end !== null ? r.end - r.start : (p.quarter === gameState.currentQuarter && player.status === 'court' ? (600000 - gameState.quarterTimes[gameState.currentQuarter]) - r.start : 0);
                return rAcc + (d > 0 ? d : 0);
            }, 0), 0);
        }

        function getCurrentStintMs(player) {
            if (player.status !== 'court') return 0;
            const perf = player.performance.find(p => p.quarter === gameState.currentQuarter);
            if (!perf) return 0;
            const last = perf.rotations[perf.rotations.length - 1];
            return (last && last.end === null) ? (600000 - gameState.quarterTimes[gameState.currentQuarter]) - last.start : 0;
        }

        function handlePlayerClick(id) {
            const p = gameState.players.find(x => x.id === id);
            if (selectedPlayerId === null) { selectedPlayerId = id; } 
            else if (selectedPlayerId === id) { selectedPlayerId = null; } 
            else {
                const p1 = gameState.players.find(x => x.id === selectedPlayerId);
                if (p1.status !== p.status) { performSubstitution(p1, p); selectedPlayerId = null; } 
                else { selectedPlayerId = id; }
            }
            updateUI();
        }

        function performSubstitution(p1, p2) {
            saveToHistory();
            const now = 600000 - gameState.quarterTimes[gameState.currentQuarter];
            const courtP = p1.status === 'court' ? p1 : p2;
            const benchP = p1.status === 'bench' ? p1 : p2;

            let perfOut = courtP.performance.find(x => x.quarter === gameState.currentQuarter);
            if (perfOut) {
                let last = perfOut.rotations[perfOut.rotations.length - 1];
                if (last && last.end === null) last.end = now;
            }
            courtP.status = 'bench';

            let perfIn = benchP.performance.find(x => x.quarter === gameState.currentQuarter);
            if (!perfIn) { perfIn = { quarter: gameState.currentQuarter, rotations: [] }; benchP.performance.push(perfIn); }
            perfIn.rotations.push({ start: now, end: null });
            benchP.status = 'court';

            localStorage.setItem('basket_rotation_fivein_v1', JSON.stringify(gameState));
        }

        function saveToHistory() {
            history.push(JSON.parse(JSON.stringify(gameState)));
            if (history.length > 20) history.shift();
            updateUndoButton();
        }

        function undoSubstitution() {
            if (history.length > 0) {
                gameState = history.pop();
                updateUI();
                updateUndoButton();
                localStorage.setItem('basket_rotation_fivein_v1', JSON.stringify(gameState));
            }
        }

        function updateUndoButton() {
            const btn = document.getElementById('undo-btn');
            if (history.length > 0) { btn.classList.remove('opacity-50', 'cursor-not-allowed'); } 
            else { btn.classList.add('opacity-50', 'cursor-not-allowed'); }
        }

        function toggleTimer() {
            if (gameState.isRunning) { clearInterval(timerInterval); gameState.isRunning = false; }
            else { gameState.lastUpdateTime = Date.now(); timerInterval = setInterval(updateTimer, 100); gameState.isRunning = true; }
            document.getElementById('start-pause-btn').innerText = gameState.isRunning ? 'Pausa' : 'Avvia';
            document.getElementById('start-pause-btn').className = gameState.isRunning ? 'bg-yellow-600 text-white font-bold py-3 px-4 rounded-xl w-24' : 'bg-green-600 text-white font-bold py-3 px-4 rounded-xl w-24';
        }

        function updateTimer() {
            const delta = Date.now() - gameState.lastUpdateTime;
            gameState.lastUpdateTime = Date.now();
            gameState.quarterTimes[gameState.currentQuarter] = Math.max(0, gameState.quarterTimes[gameState.currentQuarter] - delta);
            if (gameState.quarterTimes[gameState.currentQuarter] === 0) { toggleTimer(); handleQuarterEnd(); }
            updateUI();
        }

        function handleQuarterEnd() {
            const now = 600000;
            gameState.players.filter(p => p.status === 'court').forEach(p => {
                let perf = p.performance.find(x => x.quarter === gameState.currentQuarter);
                if (perf) { let last = perf.rotations[perf.rotations.length - 1]; if (last && last.end === null) last.end = now; }
            });
        }

        /* FIX LOGICA CAMBIO QUARTO */
        function changeQuarter() {
            gameState.currentQuarter = document.getElementById('quarter-select').value;
            const nowInQuarter = 600000 - gameState.quarterTimes[gameState.currentQuarter];
            
            // Per ogni giocatore che √® segnato come "in campo"
            gameState.players.filter(p => p.status === 'court').forEach(p => {
                let perf = p.performance.find(x => x.quarter === gameState.currentQuarter);
                if (!perf) {
                    // Se non ha performance in questo quarto, le creiamo e iniziamo lo stint
                    perf = { quarter: gameState.currentQuarter, rotations: [{ start: nowInQuarter, end: null }] };
                    p.performance.push(perf);
                } else {
                    // Se le ha, controlliamo che ci sia uno stint aperto
                    let last = perf.rotations[perf.rotations.length - 1];
                    if (!last || last.end !== null) {
                        perf.rotations.push({ start: nowInQuarter, end: null });
                    }
                }
            });
            updateUI();
            localStorage.setItem('basket_rotation_fivein_v1', JSON.stringify(gameState));
        }

        function updateUI() {
            document.getElementById('timer-display').innerText = formatTime(gameState.quarterTimes[gameState.currentQuarter]);
            const court = document.getElementById('court-area'), bench = document.getElementById('bench-area');
            court.innerHTML = ''; bench.innerHTML = '';

            gameState.players.forEach(p => {
                const tgl = calcTGL(p), tot = calcTotalMs(p), stint = getCurrentStintMs(p);
                let color = 'text-green-600';
                if (tgl > 4832) color = 'text-red-600'; else if (tgl > 3695) color = 'text-orange-500'; else if (tgl > 2274) color = 'text-yellow-500';

                const card = `
                    <div onclick="handlePlayerClick(${p.id})" class="player-card ${p.status === 'court' ? 'on-court' : ''} ${selectedPlayerId === p.id ? 'selected-card' : ''} p-4 flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <span class="court-number font-black">${p.number}</span>
                            <div class="text-right"><p class="text-[10px] uppercase font-bold opacity-60">Load</p><p class="text-lg font-black ${color}">${tgl}</p></div>
                        </div>
                        <div class="mt-1">
                            <h3 class="font-bold text-sm truncate">${p.name}</h3>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-[10px] font-mono opacity-80">TOT: ${formatTime(tot)}</p>
                                ${p.status === 'court' ? `<p class="text-[10px] font-mono ${stint > 420000 ? 'text-red-400 animate-pulse font-bold' : 'opacity-80'}">STINT: ${formatTime(stint)}</p>` : ''}
                            </div>
                        </div>
                    </div>`;
                p.status === 'court' ? court.innerHTML += card : bench.innerHTML += card;
            });
            renderTable();
        }

        function renderTable() {
            let html = `<table class="w-full text-left text-xs text-gray-800 dark:text-gray-200"><thead class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700"><tr><th class="px-4 py-2">#</th><th class="px-4 py-2">Nome</th><th class="px-4 py-2 text-right">Q1</th><th class="px-4 py-2 text-right">Q2</th><th class="px-4 py-2 text-right">Q3</th><th class="px-4 py-2 text-right">Q4</th><th class="px-4 py-2 text-right font-bold">TOT</th><th class="px-4 py-2 text-right font-bold">TGL</th></tr></thead><tbody>`;
            gameState.players.forEach(p => {
                html += `<tr class="border-b border-gray-100 dark:border-gray-700">
                    <td class="px-4 py-2 font-bold">${p.number}</td>
                    <td class="px-4 py-2">${p.name}</td>
                    <td class="px-4 py-2 text-right opacity-60">${formatTime(calcQuarterMs(p, 'Q1'))}</td>
                    <td class="px-4 py-2 text-right opacity-60">${formatTime(calcQuarterMs(p, 'Q2'))}</td>
                    <td class="px-4 py-2 text-right opacity-60">${formatTime(calcQuarterMs(p, 'Q3'))}</td>
                    <td class="px-4 py-2 text-right opacity-60">${formatTime(calcQuarterMs(p, 'Q4'))}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatTime(calcTotalMs(p))}</td>
                    <td class="px-4 py-2 text-right font-bold">${calcTGL(p)}</td>
                </tr>`;
            });
            document.getElementById('total-stats-area').innerHTML = html + `</tbody></table>`;
        }

        function calcQuarterMs(p, q) {
            const perf = p.performance.find(x => x.quarter === q);
            if (!perf) return 0;
            return perf.rotations.reduce((acc, r) => {
                let end = r.end !== null ? r.end : (q === gameState.currentQuarter ? 600000 - gameState.quarterTimes[q] : 0);
                let dur = end - r.start;
                return acc + (dur > 0 ? dur : 0);
            }, 0);
        }

        function formatTime(ms) { const s = Math.floor(Math.max(0, ms) / 1000); return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`; }
        function adjustTime(ms) { gameState.quarterTimes[gameState.currentQuarter] = Math.max(0, Math.min(600000, gameState.quarterTimes[gameState.currentQuarter] + ms)); updateUI(); }

        function initializeGame() {
            const lines = document.getElementById('player-input').value.split('\n');
            gameState.players = lines.map((l, i) => {
                const parts = l.trim().split(/[ .]+/);
                return { id: i, number: parts[0] || '??', name: parts.slice(1).join(' '), status: i < 5 ? 'court' : 'bench', performance: [] };
            }).filter(p => p.name);
            ['Q1','Q2','Q3','Q4','OT'].forEach(q => gameState.quarterTimes[q] = 600000);
            gameState.players.filter(p => p.status === 'court').forEach(p => p.performance = [{ quarter: 'Q1', rotations: [{ start: 0, end: null }] }]);
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateUI();
        }

        window.onload = () => {
            const saved = localStorage.getItem('basket_rotation_fivein_v1');
            if (saved) { gameState = JSON.parse(saved); document.getElementById('game-container').classList.remove('hidden'); updateUI(); }
            else document.getElementById('setup-modal').classList.remove('hidden');
        };
    </script>
</body>
</html>
