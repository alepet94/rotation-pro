<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FiveIN</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { gray: { 900: '#111827', 800: '#1f2937', 700: '#374151' } } } }
        }
    </script>

    <style>
        @font-face {
            font-family: 'DS-Digital';
            src: url('DS-DIGII.TTF') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; overscroll-behavior-y: contain; transition: background-color 0.3s, color 0.3s; }
        
        .court-area {
            background-color: #eebb88;
            background-image: repeating-linear-gradient(0deg, transparent 0px, transparent 58px, rgba(160, 82, 45, 0.15) 59px, rgba(160, 82, 45, 0.15) 60px), repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 30px, transparent 30px, transparent 60px);
            border: 6px solid #ffffff; 
            box-shadow: inset 0 0 60px rgba(0,0,0,0.15); 
            position: relative; 
            overflow-y: auto; 
            min-height: 400px;
        }
        .court-lines::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: #ffffff; pointer-events: none; z-index: 1; }
        .court-lines::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 120px; border: 4px solid #ffffff; border-radius: 50%; pointer-events: none; z-index: 1; }
        .dark .court-area { background-color: #cfa06b; border-color: #e2e8f0; }
        
        .bench-area {
            background-color: #f8fafc;
            background-image: linear-gradient(45deg, #e2e8f0 25%, transparent 25%, transparent 75%, #e2e8f0 75%, #e2e8f0), linear-gradient(45deg, #e2e8f0 25%, transparent 25%, transparent 75%, #e2e8f0 75%, #e2e8f0);
            background-size: 20px 20px; border: 2px dashed #94a3b8; min-height: 140px;
        }
        .dark .bench-area { background-color: #1e293b; background-image: linear-gradient(45deg, #334155 25%, transparent 25%, transparent 75%, #334155 75%, #334155), linear-gradient(45deg, #334155 25%, transparent 25%, transparent 75%, #334155 75%, #334155); border-color: #475569; }
        
        .player-card { touch-action: manipulation; cursor: pointer; background: rgba(255, 255, 255, 0.98); border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.15s ease, box-shadow 0.15s; z-index: 10; position: relative; min-height: 9rem; height: auto; user-select: none; }
        .player-card.on-court { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); color: white; box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.4); }
        .dark .player-card:not(.on-court) { background: rgba(30, 41, 59, 0.98); color: #f1f5f9; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .player-card:active { transform: scale(0.96); }
        .selected-card { ring: 3px solid #fbbf24; transform: scale(1.02); box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); border-color: #fbbf24 !important; z-index: 20; }
        .court-number { color: #fbbf24; font-size: 1.6rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .timer-display { font-family: 'DS-Digital', 'Courier New', monospace; font-weight: 700; font-size: 3rem; line-height: 1; letter-spacing: -2px; color: #ef4444; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .stats-row:nth-child(even) { background-color: rgba(0,0,0,0.03); }
        .dark .stats-row:nth-child(even) { background-color: rgba(255,255,255,0.02); }
    </style>
</head>
<body class="p-2 sm:p-6 bg-gray-100 dark:bg-gray-900 select-none h-screen flex flex-col">

    <div class="max-w-7xl mx-auto w-full flex flex-col h-full safe-area-padding">
        
        <header class="flex justify-between items-center mb-3 py-2 flex-shrink-0 flex-wrap gap-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4 flex-1">
                <div><h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800 dark:text-white tracking-tight">üèÄ FiveIN</h1></div>
                <div class="mt-2 sm:mt-0 flex items-center">
                    <label for="opponent-name" class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-2 flex-shrink-0">Avversaria:</label>
                    <input type="text" id="opponent-name" placeholder="Nome Squadra" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white font-medium text-sm py-1 px-2 rounded-lg outline-none w-full max-w-xs">
                </div>
            </div>
            <div class="flex items-center space-x-3 order-last">
                <button onclick="exportToCSV()" class="p-2 rounded-full bg-blue-600 text-white shadow-sm hover:shadow-md text-xs font-bold uppercase">CSV</button>
                <button id="theme-toggle" onclick="toggleTheme()" class="p-2 rounded-full bg-white dark:bg-gray-800 text-gray-800 dark:text-yellow-400">
                    <svg id="sun-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moon-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </header>

        <div id="setup-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Roster Squadra</h2>
                <textarea id="player-input" rows="8" class="w-full p-4 border rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white text-lg font-medium outline-none">00 Leardini
7 Tomassini
11 Denegri
12 Sankare
13 Marini
17 Ogden
18 Pollone
22 Robinson
27 Simioni
29 Camara</textarea>
                <button onclick="initializeGame()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition text-lg">Inizia Partita</button>
            </div>
        </div>

        <div id="game-container" class="flex-1 flex flex-col min-h-0 pb-4 hidden">
            <div class="bg-white dark:bg-gray-800 p-3 sm:p-4 rounded-2xl shadow-sm mb-4 flex flex-wrap sm:flex-nowrap justify-between items-center gap-4 border border-gray-200 dark:border-gray-700">
                <div class="flex-1 flex justify-center items-center gap-3 order-1 sm:order-2">
                    <button onclick="adjustTime(30000)" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 font-bold text-xs">+30"</button>
                    <div class="bg-gray-100 dark:bg-gray-900 px-6 py-2 rounded-xl border border-gray-200 dark:border-gray-700 min-w-[200px] text-center">
                        <span id="timer-display" class="timer-display">10:00</span>
                    </div>
                    <button onclick="adjustTime(-30000)" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 font-bold text-xs">-30"</button>
                </div>
                <div class="order-2 sm:order-3">
                    <select id="quarter-select" onchange="changeQuarter()" class="bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 text-gray-800 dark:text-white font-bold text-lg py-3 px-4 rounded-xl outline-none">
                        <option value="Q1">Q1</option>
                        <option value="Q2">Q2</option>
                        <option value="Q3">Q3</option>
                        <option value="Q4">Q4</option>
                        <option value="OT">OT</option>
                    </select>
                </div>
                <div class="flex gap-2 order-3 sm:order-1 justify-center">
                    <button id="start-pause-btn" onclick="toggleTimer()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-xl w-28">Avvia</button>
                    <button onclick="showSetupOrGame(false); clearInterval(timerInterval); gameState.isRunning = false;" class="bg-red-500 text-white font-bold py-3 px-6 rounded-xl w-28">Reset</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 flex-1 min-h-0">
                <div class="lg:col-span-3 flex flex-col min-h-0 order-2 lg:order-1">
                    <div class="bg-white dark:bg-gray-800 rounded-t-xl p-3 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                        <h2 class="font-bold text-gray-500 dark:text-gray-400 uppercase text-sm tracking-wider">Panchina</h2>
                    </div>
                    <div id="bench-area" class="bench-area p-3 rounded-b-xl flex-1 overflow-y-auto grid grid-cols-2 lg:grid-cols-1 gap-3 content-start shadow-inner" onclick="handleAreaClick('bench')"></div>
                </div>
                <div class="lg:col-span-9 flex flex-col min-h-0 order-1 lg:order-2 space-y-4">
                    <div class="relative rounded-2xl overflow-hidden shadow-2xl border-[6px] border-white dark:border-gray-500 flex-1 flex flex-col">
                        <div class="absolute top-0 left-0 bg-black/50 text-white px-4 py-1 rounded-br-xl z-20 text-sm font-bold uppercase backdrop-blur-md">In Campo</div>
                        <div class="court-lines absolute inset-0 z-0"></div>
                        <div id="court-area" class="court-area relative z-10 p-4 sm:p-6 flex-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 sm:gap-4 content-start items-start" onclick="handleAreaClick('court')"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col h-48 lg:h-64">
                        <div class="p-3 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center"><h2 class="font-bold text-gray-500 dark:text-gray-400 uppercase text-sm tracking-wider">Tabellino</h2></div>
                        <div id="total-stats-area" class="overflow-y-auto custom-scroll p-0 flex-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FIX_LOOKUP = [
            { l: 16, v: 1.05 }, { l: 30, v: 1.10 }, { l: 45, v: 1.15 }, { l: 60, v: 1.20 },
            { l: 75, v: 1.25 }, { l: 90, v: 1.30 }, { l: 105, v: 1.35 }, { l: 120, v: 1.40 },
            { l: 135, v: 1.45 }, { l: 150, v: 1.50 }, { l: 165, v: 1.55 }, { l: 180, v: 1.60 },
            { l: 195, v: 1.65 }, { l: 210, v: 1.70 }, { l: 225, v: 1.75 }, { l: 240, v: 1.80 },
            { l: 255, v: 1.83 }, { l: 270, v: 1.85 }, { l: 285, v: 1.88 }, { l: 300, v: 1.90 },
            { l: 315, v: 1.91 }, { l: 330, v: 1.93 }, { l: 345, v: 1.94 }, { l: 360, v: 1.95 },
            { l: 375, v: 1.96 }, { l: 390, v: 1.98 }, { l: 405, v: 1.99 }, { l: 420, v: 2.00 }
        ];

        const QUARTER_DURATIONS_MS = { 'Q1': 600000, 'Q2': 600000, 'Q3': 600000, 'Q4': 600000, 'OT': 300000 };
        const QUARTER_ORDER = ['Q1', 'Q2', 'Q3', 'Q4', 'OT'];
        const STORAGE_KEY = 'basket_rotation_fivein_v1';
        
        let gameState = { players: [], isRunning: false, lastUpdateTime: 0, currentQuarter: 'Q1', quarterTimes: {} };
        let timerInterval = null;
        let selectedPlayerId = null;

        // --- NUOVA LOGICA FATIGUE MULTIPLIER ---
        function getFatigueMultiplier(stintIndex, totMinutesBefore) {
            const s = stintIndex + 1;
            if (s === 1) return 1.0;
            if (s === 2) {
                if (totMinutesBefore <= 4) return 1.005;
                if (totMinutesBefore <= 6) return 1.007;
                if (totMinutesBefore <= 8) return 1.010;
                return 1.012;
            }
            if (s === 3) {
                if (totMinutesBefore <= 4) return 1.003;
                if (totMinutesBefore <= 6) return 1.005;
                if (totMinutesBefore <= 8) return 1.008;
                if (totMinutesBefore <= 10) return 1.010;
                if (totMinutesBefore <= 12) return 1.013;
                if (totMinutesBefore <= 14) return 1.014;
                if (totMinutesBefore <= 16) return 1.016;
                if (totMinutesBefore <= 18) return 1.018;
                return 1.020;
            }
            if (s === 4) {
                if (totMinutesBefore <= 6) return 1.000;
                if (totMinutesBefore <= 8) return 1.005;
                if (totMinutesBefore <= 10) return 1.008;
                if (totMinutesBefore <= 12) return 1.010;
                if (totMinutesBefore <= 14) return 1.013;
                if (totMinutesBefore <= 16) return 1.016;
                if (totMinutesBefore <= 18) return 1.018;
                if (totMinutesBefore <= 20) return 1.020;
                if (totMinutesBefore <= 22) return 1.023;
                if (totMinutesBefore <= 24) return 1.026;
                if (totMinutesBefore <= 28) return 1.030;
                return 1.035;
            }
            if (s === 5 || s >= 6) {
                if (totMinutesBefore <= 8) return 1.000;
                if (totMinutesBefore <= 12) return 1.002;
                if (totMinutesBefore <= 16) return 1.005;
                if (totMinutesBefore <= 18) return 1.010;
                if (totMinutesBefore <= 20) return 1.012;
                if (totMinutesBefore <= 22) return 1.015;
                if (totMinutesBefore <= 24) return 1.020;
                if (totMinutesBefore <= 28) return 1.025;
                return (s === 5) ? 1.035 : 1.030; // 3.5% per 5, 3% per 6+ a 28-30 min
            }
            return 1.0;
        }

        function getFIx(seconds) {
            const entry = FIX_LOOKUP.find(e => seconds <= e.l);
            return entry ? entry.v : 2.05;
        }

        function calcTGL(player) {
            let tglAccumulated = 0;
            let totMinBefore = 0;
            let allStints = [];

            player.performance.forEach(perf => {
                const qDur = QUARTER_DURATIONS_MS[perf.quarter];
                perf.rotations.forEach(r => {
                    let durationMs = 0;
                    if (r.end !== null) durationMs = r.end - r.start;
                    else if (perf.quarter === gameState.currentQuarter && player.status === 'court') {
                        durationMs = (QUARTER_DURATIONS_MS[gameState.currentQuarter] - gameState.quarterTimes[gameState.currentQuarter]) - r.start;
                    }
                    if (durationMs > 0) allStints.push(durationMs / 1000);
                });
            });

            allStints.forEach((sec, idx) => {
                const fix = getFIx(sec);
                const mult = getFatigueMultiplier(idx, totMinBefore);
                tglAccumulated += (sec * fix * mult);
                totMinBefore += (sec / 60);
            });
            return Math.round(tglAccumulated);
        }

        // --- FUNZIONI CORE (IDENTICHE AL BACKUP) ---
        function toggleTimer() {
            if (gameState.isRunning) {
                clearInterval(timerInterval);
                gameState.isRunning = false;
                document.getElementById('start-pause-btn').innerText = 'Avvia';
                document.getElementById('start-pause-btn').className = 'bg-green-600 text-white font-bold py-3 px-6 rounded-xl w-28';
            } else {
                gameState.lastUpdateTime = Date.now();
                timerInterval = setInterval(updateTimer, 100);
                gameState.isRunning = true;
                document.getElementById('start-pause-btn').innerText = 'Pausa';
                document.getElementById('start-pause-btn').className = 'bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl w-28';
            }
            saveState();
        }

        function updateTimer() {
            const now = Date.now();
            const delta = now - gameState.lastUpdateTime;
            gameState.lastUpdateTime = now;
            let rem = gameState.quarterTimes[gameState.currentQuarter] - delta;
            if (rem <= 0) { rem = 0; toggleTimer(); }
            gameState.quarterTimes[gameState.currentQuarter] = rem;
            updateUI();
        }

        function handlePlayerClick(id) {
            const player = gameState.players.find(p => p.id === id);
            const now = QUARTER_DURATIONS_MS[gameState.currentQuarter] - gameState.quarterTimes[gameState.currentQuarter];

            if (player.status === 'bench') {
                if (gameState.players.filter(p => p.status === 'court').length >= 5) return;
                player.status = 'court';
                let perf = player.performance.find(p => p.quarter === gameState.currentQuarter);
                if (!perf) { perf = { quarter: gameState.currentQuarter, rotations: [] }; player.performance.push(perf); }
                perf.rotations.push({ start: now, end: null });
            } else {
                player.status = 'bench';
                let perf = player.performance.find(p => p.quarter === gameState.currentQuarter);
                if (perf) {
                    let last = perf.rotations[perf.rotations.length - 1];
                    if (last && last.end === null) last.end = now;
                }
            }
            saveState();
            updateUI();
        }

        function updateUI() {
            document.getElementById('timer-display').innerText = formatTime(gameState.quarterTimes[gameState.currentQuarter]);
            const court = document.getElementById('court-area');
            const bench = document.getElementById('bench-area');
            court.innerHTML = ''; bench.innerHTML = '';

            gameState.players.forEach(p => {
                const tgl = calcTGL(p);
                let color = 'text-green-600';
                if (tgl > 4832) color = 'text-red-600';
                else if (tgl > 3695) color = 'text-orange-500';
                else if (tgl > 2274) color = 'text-yellow-500';

                const card = `
                    <div onclick="handlePlayerClick(${p.id})" class="player-card ${p.status === 'court' ? 'on-court' : ''} p-4 flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <span class="court-number font-black">${p.number}</span>
                            <div class="text-right"><p class="text-[10px] uppercase font-bold opacity-60">Load</p><p class="text-lg font-black ${color}">${tgl}</p></div>
                        </div>
                        <h3 class="font-bold text-sm truncate">${p.name}</h3>
                    </div>`;
                if (p.status === 'court') court.innerHTML += card;
                else bench.innerHTML += card;
            });
            renderTable();
        }

        function renderTable() {
            let html = `<table class="w-full text-left text-xs"><thead class="sticky top-0 bg-white dark:bg-gray-800 z-10 border-b">
                <tr><th class="px-4 py-2">#</th><th class="px-4 py-2">Nome</th><th class="px-4 py-2 text-right">Q1</th><th class="px-4 py-2 text-right">Q2</th><th class="px-4 py-2 text-right">Q3</th><th class="px-4 py-2 text-right">Q4</th><th class="px-4 py-2 text-right">TGL</th></tr></thead><tbody>`;
            gameState.players.forEach(p => {
                html += `<tr class="stats-row">
                    <td class="px-4 py-2 font-bold">${p.number}</td>
                    <td class="px-4 py-2">${p.name}</td>
                    <td class="px-4 py-2 text-right text-gray-500">${formatTime(calcQuarterMs(p, 'Q1'))}</td>
                    <td class="px-4 py-2 text-right text-gray-500">${formatTime(calcQuarterMs(p, 'Q2'))}</td>
                    <td class="px-4 py-2 text-right text-gray-500">${formatTime(calcQuarterMs(p, 'Q3'))}</td>
                    <td class="px-4 py-2 text-right text-gray-500">${formatTime(calcQuarterMs(p, 'Q4'))}</td>
                    <td class="px-4 py-2 text-right font-bold">${calcTGL(p)}</td>
                </tr>`;
            });
            document.getElementById('total-stats-area').innerHTML = html + `</tbody></table>`;
        }

        function calcQuarterMs(p, q) {
            const perf = p.performance.find(x => x.quarter === q);
            if (!perf) return 0;
            return perf.rotations.reduce((acc, r) => {
                const end = r.end !== null ? r.end : (gameState.currentQuarter === q ? (QUARTER_DURATIONS_MS[q] - gameState.quarterTimes[q]) : QUARTER_DURATIONS_MS[q]);
                return acc + (end - r.start);
            }, 0);
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        function initializeGame() {
            const input = document.getElementById('player-input').value;
            const lines = input.split('\n');
            gameState.players = lines.map((l, i) => {
                const parts = l.trim().split(/[ .]+/);
                return { id: i, number: parts[0] || '??', name: parts.slice(1).join(' ') || 'Giocatore', status: 'bench', performance: [] };
            }).filter(p => p.name);
            QUARTER_ORDER.forEach(q => gameState.quarterTimes[q] = QUARTER_DURATIONS_MS[q]);
            showSetupOrGame(true);
            saveState();
            updateUI();
        }

        function showSetupOrGame(isGame) {
            document.getElementById('setup-modal').classList.toggle('hidden', isGame);
            document.getElementById('game-container').classList.toggle('hidden', !isGame);
        }

        function changeQuarter() {
            gameState.currentQuarter = document.getElementById('quarter-select').value;
            updateUI();
        }

        function adjustTime(ms) {
            gameState.quarterTimes[gameState.currentQuarter] = Math.max(0, Math.min(QUARTER_DURATIONS_MS[gameState.currentQuarter], gameState.quarterTimes[gameState.currentQuarter] + ms));
            updateUI();
        }

        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState)); }

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                gameState = JSON.parse(saved);
                showSetupOrGame(true);
                updateUI();
            } else showSetupOrGame(false);
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        };
    </script>
</body>
</html>
