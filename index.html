<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FiveIN - Monitoraggio Carico</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        gray: { 900: '#111827', 800: '#1f2937', 700: '#374151' } 
                    } 
                } 
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .stats-row:nth-child(even) { background-color: rgba(0,0,0,0.02); }
        .dark .stats-row:nth-child(even) { background-color: rgba(255,255,255,0.02); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üèÄ</span>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-500">FiveIN</h1>
                </div>
                <div id="gameClockDisplay" class="font-mono text-2xl font-bold text-red-600 bg-black px-4 py-1 rounded border-2 border-gray-700">
                    10:00
                </div>
                <div class="flex items-center gap-2">
                    <span id="currentQuarterLabel" class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300 uppercase">Q1</span>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">üåô</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 col-span-2">
                <div class="flex flex-wrap gap-3">
                    <button onclick="startClock()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg active:scale-95">START</button>
                    <button onclick="stopClock()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg active:scale-95">STOP</button>
                    <button onclick="nextQuarter()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 py-3 px-6 rounded-lg font-semibold transition-colors">PROSSIMO QUARTO</button>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col justify-center">
                <div class="text-center">
                    <p class="text-sm text-gray-500 uppercase font-bold tracking-wider">Tempo Totale Gioco</p>
                    <p id="totalMatchTime" class="text-3xl font-mono font-bold text-blue-600">00:00</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="space-y-4">
                <h3 class="text-lg font-bold flex items-center gap-2 text-green-600">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span> IN CAMPO (5)
                </h3>
                <div id="courtList" class="grid grid-cols-1 gap-3"></div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lg font-bold flex items-center gap-2 text-gray-500">
                    <span class="w-3 h-3 bg-gray-400 rounded-full"></span> PANCHINA
                </h3>
                <div id="benchList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold">Riepilogo Carico Live</h3>
                <button onclick="exportData()" class="text-sm bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 transition-colors">Esporta CSV</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-gray-700/50 text-xs uppercase tracking-wider text-gray-500">
                            <th class="px-4 py-3">#</th>
                            <th class="px-4 py-3">Nome</th>
                            <th class="px-4 py-3 text-right">Q1</th>
                            <th class="px-4 py-3 text-right">Q2</th>
                            <th class="px-4 py-3 text-right">Q3</th>
                            <th class="px-4 py-3 text-right">Q4</th>
                            <th class="px-4 py-3 text-right text-black dark:text-white">Partita</th>
                            <th class="px-4 py-3 text-right text-black dark:text-white">TGL</th>
                            <th class="px-4 py-3 text-right">Stint Attuale</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURAZIONE E COSTANTI ---
        
        // Tabella FIx (Secondi -> Moltiplicatore Intensit√†)
        const FIX_LOOKUP = [
            {max: 15, val: 1.05}, {max: 30, val: 1.10}, {max: 45, val: 1.15}, {max: 60, val: 1.20},
            {max: 75, val: 1.25}, {max: 90, val: 1.30}, {max: 105, val: 1.35}, {max: 120, val: 1.40},
            {max: 135, val: 1.45}, {max: 150, val: 1.50}, {max: 165, val: 1.55}, {max: 180, val: 1.60},
            {max: 195, val: 1.65}, {max: 210, val: 1.70}, {max: 225, val: 1.75}, {max: 240, val: 1.80},
            {max: 255, val: 1.83}, {max: 270, val: 1.85}, {max: 285, val: 1.88}, {max: 300, val: 1.90},
            {max: 315, val: 1.91}, {max: 330, val: 1.93}, {max: 345, val: 1.94}, {max: 360, val: 1.95},
            {max: 375, val: 1.96}, {max: 390, val: 1.98}, {max: 405, val: 1.99}, {max: 420, val: 2.00},
            {max: 435, val: 2.01}, {max: 450, val: 2.02}, {max: 465, val: 2.03}, {max: 480, val: 2.04},
            {max: 495, val: 2.05}, {max: 510, val: 2.06}, {max: 525, val: 2.07}, {max: 540, val: 2.08},
            {max: 555, val: 2.09}, {max: 570, val: 2.10}, {max: 585, val: 2.11}, {max: 600, val: 2.12}
        ];

        // Zone di Carico (Soglie TGL)
        const TGL_ZONES = {
            VERDE: { max: 2274, color: 'text-green-500', bg: 'bg-green-100' },
            GIALLO: { max: 3695, color: 'text-yellow-500', bg: 'bg-yellow-100' },
            ARANCIO: { max: 4832, color: 'text-orange-500', bg: 'bg-orange-100' },
            ROSSO: { max: Infinity, color: 'text-red-500', bg: 'bg-red-100' }
        };

        // --- STATO DELL'APP ---
        let gameState = {
            timer: null,
            remainingTime: 600000, // 10 min in ms
            currentQuarter: 'Q1',
            isClockRunning: false,
            lastTick: null
        };

        let players = [
            { id: 1, number: "00", name: "Giocatore 1", status: 'bench', performance: [] },
            { id: 2, number: "1", name: "Giocatore 2", status: 'bench', performance: [] },
            { id: 3, number: "2", name: "Giocatore 3", status: 'bench', performance: [] },
            { id: 4, number: "5", name: "Giocatore 4", status: 'bench', performance: [] },
            { id: 5, number: "8", name: "Giocatore 5", status: 'bench', performance: [] },
            { id: 6, number: "10", name: "Giocatore 6", status: 'bench', performance: [] },
            { id: 7, number: "12", name: "Giocatore 7", status: 'bench', performance: [] },
            { id: 8, number: "15", name: "Giocatore 8", status: 'bench', performance: [] },
            { id: 9, number: "21", name: "Giocatore 9", status: 'bench', performance: [] },
            { id: 10, number: "23", name: "Giocatore 10", status: 'bench', performance: [] },
            { id: 11, number: "30", name: "Giocatore 11", status: 'bench', performance: [] },
            { id: 12, number: "77", name: "Giocatore 12", status: 'bench', performance: [] }
        ];

        // --- LOGICA DI CALCOLO CARICO (NUOVA) ---

        /**
         * Restituisce il moltiplicatore di fatica residua basato sulle tue tabelle.
         * @param {number} stintIndex - Indice dello stint (0 per il primo, 1 per il secondo...)
         * @param {number} totMinutesPlayedBefore - Minuti totali giocati PRIMA di questo stint
         */
        function getFatigueMultiplier(stintIndex, totMinutes) {
            const stintNum = stintIndex + 1;

            if (stintNum === 1) return 1.0;

            if (stintNum === 2) {
                if (totMinutes <= 4) return 1.005;
                if (totMinutes <= 6) return 1.007;
                if (totMinutes <= 8) return 1.010;
                return 1.012;
            }

            if (stintNum === 3) {
                if (totMinutes <= 4) return 1.003;
                if (totMinutes <= 6) return 1.005;
                if (totMinutes <= 8) return 1.008;
                if (totMinutes <= 10) return 1.010;
                if (totMinutes <= 12) return 1.013;
                if (totMinutes <= 14) return 1.014;
                if (totMinutes <= 16) return 1.016;
                if (totMinutes <= 18) return 1.018;
                return 1.020;
            }

            if (stintNum === 4) {
                if (totMinutes <= 6) return 1.000;
                if (totMinutes <= 8) return 1.005;
                if (totMinutes <= 10) return 1.008;
                if (totMinutes <= 12) return 1.010;
                if (totMinutes <= 14) return 1.013;
                if (totMinutes <= 16) return 1.016;
                if (totMinutes <= 18) return 1.018;
                if (totMinutes <= 20) return 1.020;
                if (totMinutes <= 22) return 1.023;
                if (totMinutes <= 24) return 1.026;
                if (totMinutes <= 28) return 1.030;
                return 1.035;
            }

            if (stintNum === 5) {
                if (totMinutes <= 8) return 1.000;
                if (totMinutes <= 12) return 1.002;
                if (totMinutes <= 16) return 1.005;
                if (totMinutes <= 18) return 1.010;
                if (totMinutes <= 20) return 1.012;
                if (totMinutes <= 22) return 1.015;
                if (totMinutes <= 24) return 1.020;
                if (totMinutes <= 28) return 1.025;
                return 1.035;
            }

            if (stintNum >= 6) {
                if (totMinutes <= 8) return 1.000;
                if (totMinutes <= 12) return 1.002;
                if (totMinutes <= 16) return 1.005;
                if (totMinutes <= 18) return 1.010;
                if (totMinutes <= 20) return 1.012;
                if (totMinutes <= 22) return 1.015;
                if (totMinutes <= 24) return 1.020;
                if (totMinutes <= 28) return 1.025;
                if (totMinutes <= 30) return 1.030;
                return 1.035;
            }

            return 1.0;
        }

        function getFIx(seconds) {
            const entry = FIX_LOOKUP.find(f => seconds <= f.max);
            return entry ? entry.val : 2.12;
        }

        function calcTGL(player) {
            let tgl = 0;
            let totalMinutesPlayedBefore = 0;
            let allStints = [];

            const currentQ = gameState.currentQuarter;
            const qDuration = 600000;
            const qElapsed = qDuration - gameState.remainingTime;

            // Raccogliamo tutti gli stint (passati e attuale)
            player.performance.forEach(perf => {
                perf.rotations.forEach(r => {
                    let durationMs = 0;
                    if (r.end !== null) {
                        durationMs = r.end - r.start;
                    } else if (perf.quarter === currentQ && player.status === 'court') {
                        durationMs = qElapsed - r.start;
                    }
                    if (durationMs > 0) {
                        allStints.push(Math.floor(durationMs / 1000));
                    }
                });
            });

            // Calcolo sequenziale degli StF con moltiplicatore FR
            allStints.forEach((stintSec, index) => {
                const fix = getFIx(stintSec);
                const multiplier = getFatigueMultiplier(index, totalMinutesPlayedBefore);
                
                const stf = (stintSec * fix) * multiplier;
                tgl += stf;
                
                totalMinutesPlayedBefore += (stintSec / 60);
            });

            return Math.round(tgl);
        }

        function getTGLZone(tgl) {
            if (tgl <= TGL_ZONES.VERDE.max) return TGL_ZONES.VERDE;
            if (tgl <= TGL_ZONES.GIALLO.max) return TGL_ZONES.GIALLO;
            if (tgl <= TGL_ZONES.ARANCIO.max) return TGL_ZONES.ARANCIO;
            return TGL_ZONES.ROSSO;
        }

        // --- GESTIONE CORE APP (UI & EVENTI) ---

        function togglePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            const currentQ = gameState.currentQuarter;
            const qDuration = 600000;
            const qElapsed = qDuration - gameState.remainingTime;

            if (player.status === 'bench') {
                const courtPlayers = players.filter(p => p.status === 'court').length;
                if (courtPlayers >= 5) {
                    alert("Ci sono gi√† 5 giocatori in campo!");
                    return;
                }
                player.status = 'court';
                let perf = player.performance.find(p => p.quarter === currentQ);
                if (!perf) {
                    perf = { quarter: currentQ, rotations: [] };
                    player.performance.push(perf);
                }
                perf.rotations.push({ start: qElapsed, end: null });
            } else {
                player.status = 'bench';
                const perf = player.performance.find(p => p.quarter === currentQ);
                if (perf) {
                    const lastRot = perf.rotations[perf.rotations.length - 1];
                    if (lastRot && lastRot.end === null) lastRot.end = qElapsed;
                }
            }
            updateUI();
        }

        function startClock() {
            if (gameState.isClockRunning) return;
            gameState.isClockRunning = true;
            gameState.lastTick = Date.now();
            gameState.timer = setInterval(() => {
                const now = Date.now();
                const delta = now - gameState.lastTick;
                gameState.remainingTime -= delta;
                gameState.lastTick = now;

                if (gameState.remainingTime <= 0) {
                    gameState.remainingTime = 0;
                    stopClock();
                }
                updateUI();
            }, 100);
        }

        function stopClock() {
            gameState.isClockRunning = false;
            clearInterval(gameState.timer);
            updateUI();
        }

        function nextQuarter() {
            stopClock();
            const qs = ['Q1', 'Q2', 'Q3', 'Q4', 'OT', '2OT'];
            const idx = qs.indexOf(gameState.currentQuarter);
            if (idx < qs.length - 1) {
                // Chiudiamo rotazioni attive
                players.forEach(p => {
                    if (p.status === 'court') {
                        const perf = p.performance.find(perf => perf.quarter === gameState.currentQuarter);
                        if (perf) {
                            const lastRot = perf.rotations[perf.rotations.length - 1];
                            if (lastRot && lastRot.end === null) lastRot.end = 600000;
                        }
                    }
                });

                gameState.currentQuarter = qs[idx + 1];
                gameState.remainingTime = 600000;
                
                // Riapriamo rotazioni se ancora in campo
                players.forEach(p => {
                    if (p.status === 'court') {
                        p.performance.push({ quarter: gameState.currentQuarter, rotations: [{ start: 0, end: null }] });
                    }
                });
            }
            updateUI();
        }

        function formatTime(ms) {
            const totalSec = Math.floor(ms / 1000);
            const m = Math.floor(totalSec / 60);
            const s = totalSec % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function updateUI() {
            // Clock
            document.getElementById('gameClockDisplay').innerText = formatTime(gameState.remainingTime);
            document.getElementById('currentQuarterLabel').innerText = gameState.currentQuarter;
            
            // Match Time
            const qIdx = ['Q1', 'Q2', 'Q3', 'Q4', 'OT', '2OT'].indexOf(gameState.currentQuarter);
            const totalMatchMs = (qIdx * 600000) + (600000 - gameState.remainingTime);
            document.getElementById('totalMatchTime').innerText = formatTime(totalMatchMs);

            // Lists
            const courtList = document.getElementById('courtList');
            const benchList = document.getElementById('benchList');
            const statsBody = document.getElementById('statsTableBody');

            courtList.innerHTML = '';
            benchList.innerHTML = '';
            statsBody.innerHTML = '';

            players.forEach(p => {
                const tgl = calcTGL(p);
                const zone = getTGLZone(tgl);
                
                // Card in Campo / Panchina
                const card = `
                    <div onclick="togglePlayer(${p.id})" class="cursor-pointer bg-white dark:bg-gray-800 p-3 rounded-lg border-2 ${p.status === 'court' ? 'border-green-500' : 'border-transparent shadow-sm'} flex justify-between items-center active:scale-95 transition-all">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg w-8">${p.number}</span>
                            <span class="font-semibold">${p.name}</span>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-bold ${zone.color}">TGL: ${tgl}</p>
                        </div>
                    </div>`;
                
                if (p.status === 'court') courtList.innerHTML += card;
                else benchList.innerHTML += card;

                // Tabella Stats
                const q1 = formatTime(calcQuarterStats(p, 'Q1'));
                const q2 = formatTime(calcQuarterStats(p, 'Q2'));
                const q3 = formatTime(calcQuarterStats(p, 'Q3'));
                const q4 = formatTime(calcQuarterStats(p, 'Q4'));
                const tot = formatTime(calcTotalStats(p));
                const currentStint = p.status === 'court' ? formatTime(getCurrentStintDuration(p)) : '-';

                statsBody.innerHTML += `
                    <tr class="stats-row border-b border-gray-100 dark:border-gray-700 text-sm">
                        <td class="px-4 py-3 font-bold">${p.number}</td>
                        <td class="px-4 py-3 font-medium">${p.name}</td>
                        <td class="px-4 py-3 text-right text-gray-500">${q1}</td>
                        <td class="px-4 py-3 text-right text-gray-500">${q2}</td>
                        <td class="px-4 py-3 text-right text-gray-500">${q3}</td>
                        <td class="px-4 py-3 text-right text-gray-500">${q4}</td>
                        <td class="px-4 py-3 text-right font-bold">${tot}</td>
                        <td class="px-4 py-3 text-right font-bold ${zone.color}">${tgl}</td>
                        <td class="px-4 py-3 text-right font-mono ${p.status === 'court' ? 'text-blue-500 animate-pulse' : 'text-gray-400'}">${currentStint}</td>
                    </tr>`;
            });
        }

        function calcQuarterStats(player, quarter) {
            const perf = player.performance.find(p => p.quarter === quarter);
            if (!perf) return 0;
            return perf.rotations.reduce((acc, r) => {
                const end = r.end !== null ? r.end : (gameState.currentQuarter === quarter ? (600000 - gameState.remainingTime) : 600000);
                return acc + (end - r.start);
            }, 0);
        }

        function calcTotalStats(player) {
            return player.performance.reduce((acc, p) => {
                return acc + p.rotations.reduce((rAcc, r) => {
                    const end = r.end !== null ? r.end : (gameState.currentQuarter === p.quarter ? (600000 - gameState.remainingTime) : 600000);
                    return rAcc + (end - r.start);
                }, 0);
            }, 0);
        }

        function getCurrentStintDuration(player) {
            if (player.status !== 'court') return 0;
            const perf = player.performance.find(p => p.quarter === gameState.currentQuarter);
            if (!perf) return 0;
            const lastRot = perf.rotations[perf.rotations.length - 1];
            if (!lastRot || lastRot.end !== null) return 0;
            return (600000 - gameState.remainingTime) - lastRot.start;
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        function exportData() {
            let csv = "Numero;Nome;TGL;Minuti Totali\n";
            players.forEach(p => {
                csv += `${p.number};${p.name};${calcTGL(p)};${formatTime(calcTotalStats(p))}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'export_fivein.csv');
            a.click();
        }

        // Inizializzazione
        updateUI();

    </script>
</body>
</html>
